!function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof module&&module.exports?module.exports=b():a.lightSync=b()}(this,function(){var a=function(b,c){return"undefined"==typeof c?a.get(b):a.set(b,c)};a.get=function(a){return JSON.parse(localStorage.getItem(a))},a.set=function(a,b){localStorage.setItem(a,JSON.stringify(b))},a.has=function(a){return null!==localStorage.getItem(a)},a.init=function(b,c){return a.has(b)?a.get(b):(a.set(c),c)},a.remove=function(a){localStorage.removeItem(a)},a.clear=function(){localStorage.clear()};var b=function(a,b){a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status){var c=a.responseText,d=null;try{d=JSON.parse(c)}catch(e){d=c}b(null,d)}else b({status:a.status,responseText:a.responseText})}},c={get:function(a,c){var d=new XMLHttpRequest;d.open("GET",a,!0),b(d,c),d.send()},post:function(a,c,d){var e=new XMLHttpRequest;e.open("POST",a,!0),e.setRequestHeader("Content-type","application/json"),b(e,d),e.send(JSON.stringify(c))}},d=function(a){a.on=function(a,b){"undefined"==typeof this._listeners&&(this._listeners={}),"undefined"==typeof this._listeners[a]&&(this._listeners[a]=[]),this._listeners[a].push(b)},a.off=function(a,b){if("undefined"!=typeof this._listeners[a])if("undefined"==typeof b)this._listeners[a]=[];else{var c=this._listeners[a].indexOf(b);-1!==c&&this._listeners[a].splice(c,1)}},a.trigger=function(a){if(this._listeners&&this._listeners[a])for(var b=this._listeners[a],c=Array.prototype.slice.call(arguments,1),d=0;d<b.length;++d)b[d].apply(this,c)}},e=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},f=null,g=function(a){return a?{status:a.status,responseText:a.responseText}:null},h={init:function(a){f=new Dropbox.Client(a),f.authDriver(new Dropbox.AuthDriver.Popup({receiverUrl:a.receiverUrl}))},getUserInfos:function(a){f.getAccountInfo(function(b,c){b?a(g(b)):a(null,{name:c.name})})},readFile:function(a,b){f.readFile(a,function(a,c){b(g(a),c)})},writeFile:function(a,b,c){f.writeFile(a,b,function(a){c(g(a))})},connect:function(a){f.authenticate(function(b){b?a(g(b)):h.getUserInfos(a)})}},i=null,j={},k=[],l=function(a){for(var b=0;b<k.length;++b)k[b](a)},m=setInterval(function(){gapi.auth&&(clearInterval(m),l(null))},100),n=function(a){gapi.auth?a(null):k.push(a)},o=function(a){n(function(b){return b?void a(b):void gapi.auth.authorize({client_id:i,scope:["https://www.googleapis.com/auth/drive"],immediate:!0},function(b){return b.error?void gapi.auth.authorize({client_id:i,scope:["https://www.googleapis.com/auth/drive"],immediate:!1},function(b){a(b.error?b.error:null)}):void a(null)})})},p={init:function(a){i=a.client_id},connect:function(a){o(function(b){return b?void a(b):void gapi.client.load("drive","v2",function(){gapi.client.drive.files.list({}).execute(function(b){if(!b)return void a("unable to get files list");for(var c=b.items,d=0;d<c.length;++d)j[c[d].title]=c[d].id;gapi.client.drive.about.get().execute(function(b){b?a(null,{name:b.name}):a("unable to get user infos")})})})})},readFile:function(a,b){return j[a]?void gapi.client.drive.files.get({fileId:j[a]}).execute(function(a){if(!a)return void b({status:500,responseText:"Internal Server Error"});var c=a.downloadUrl,d=gapi.auth.getToken().access_token,e=new XMLHttpRequest;e.open("GET",c),e.setRequestHeader("Authorization","Bearer "+d),e.onload=function(){b(null,e.responseText)},e.onerror=function(){b({status:e.status,responseText:e.responseText})},e.send()}):void b({status:404,responseText:"File Not Found"})},writeFile:function(a,b,c){var d="-------314159265358979323846",e="\r\n--"+d+"\r\n",f="\r\n--"+d+"--",g="text/plain",h={title:a,mimeType:g},i=e+"Content-Type: application/json\r\n\r\n"+JSON.stringify(h)+e+"Content-Type: "+g+"\r\n\r\n"+b+f,k=j[a],l="/upload/drive/v2/files";k&&(l+="/"+k);var m=gapi.client.request({path:l,method:k?"PUT":"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+d+'"'},body:i});m.execute(function(b){b?(k||(j[a]=b.id),c(null)):c("unable to write file")})}},q=function(){return a.get("datadb_key")},r=function(b){a.set("datadb_key",b)},s=function(){a.remove("datadb_key")},t=function(a,b,d){"undefined"==typeof d&&(d={}),d.command=a,d.key=q(),c.post("/obsdbserver",d,function(a,c){a?b(a):c.err?b(c.err):c.content?b(null,c.content):b(null)})},u={init:function(){},signin:function(a,b,c){t("signin",c,{user:a,pass:b})},signup:function(a,b,c){t("signup",c,{user:a,pass:b})},userAvailable:function(a,b){t("userav",b,{user:a})},testKey:function(a,b){t("testkey",b)},getUserInfos:function(a){t("userinfos",a)},readFile:function(a,b){t("readfile",b,{path:a})},writeFile:function(a,b,c){t("writefile",c,{path:a,content:b})},connect:function(a){var b=q();if(b)u.testKey(b,function(b,c){b?a(b):c?u.getUserInfos(a):(a("invalid key"),s())});else{var c=function(b,c){b?a(b):(r(c),u.getUserInfos(a))},d=prompt("LightServer Username (empty if no account)");if(""===d){d=prompt("New LightServer Username");var e=prompt("LightServer Password"),f=prompt("Repeat Your password");e!==f?a("passwords don't match"):u.signup(d,e,c)}else{var g=prompt("LightServer PassWord");u.signin(d,g,c)}}}},v={},w=a.init("_fr_co_server",null),x=!1,y=a.init("_fr_user_infos",null),z=!1,A=[],B=function(b,c){return z?void A.push(b):w||c?x?void b(null):(z=!0,c||(c=w),void v[c].connect(function(c,d){z=!1,c?b(c):(x=!0,y=d,a.set("_fr_user_infos",d),b(null));for(var e=0;e<A.length;++e)A[e](c)})):void b("no server defined")},C={addServer:function(a,b){v[a]=b},init:function(a){for(var b in a)v[b].init(a[b]);B(function(){})},connect:function(b,c){return w?void c("already conected"):void B(function(d){d?c(d):(w=b,a.set("_fr_co_server",w),c(null))},b)},signout:function(){a.set("_fr_co_server",null),w=null,x=!1,a.set("fr_user_infos",null),y=null,A=[]},isConfigured:function(){return!!w},isConnected:function(){return x},getUserInfos:function(){return y},getServerName:function(){return w},readFile:function(a,b){B(function(c){c?b(c):v[w].readFile(a,b)})},writeFile:function(a,b,c){B(function(d){d?c(d):v[w].writeFile(a,b,c)})}};C.addServer("googledrive",p),C.addServer("dropbox",h),C.addServer("lightserver",u);var D={},E=function(a){if("undefined"!=typeof Object.create)return Object.create(a);var b=function(){};return b.prototype=a,new b},F=function(){return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},G={init:function(a){this._key=a+"_",this._items=[];for(var b=M.getKeys(),c=0;c<b.length;++c)if(0===b[c].indexOf(this._key)){var d=b[c].substr(this._key.length),f=M.getItem(b[c]);f.id=d,f.date=new Date(M.getModifiedTime(b[c])),this._items.push(f)}var g=this;M.on("serversetAny",function(a){if(0===a.indexOf(g._key)){var b=a.substr(g._key.length),c=M.getItem(a);c.date=new Date(M.getModifiedTime(a));for(var d=0;d<g._items.length&&g._items[d].id!==b;++d);if(d===g._items.length)c.id=b,g._items.push(c),g.trigger("add",c);else{var f=e(g._items[d]);for(var h in c)g._items[d][h]=c[h];g.trigger("update_"+c.id,f,c),g.trigger("updateAny",f,c)}g.trigger("change")}}),M.on("serverremoveAny",function(a){if(0===a.indexOf(g._key)){for(var b=a.substr(g._key.length),c=0;g._items[c].id!==b;++c);var d=g._items[c];g._items.splice(c,1),g.trigger("remove_"+d.id,d),g.trigger("removeAny",d),g.trigger("change")}}),M.on("clear",function(){for(var a=0;a<g._items.length;){var b=g._items[0];g._items.splice(0,1),g.trigger("remove_"+b.id,b),g.trigger("removeAny",b)}g.trigger("clear"),g.trigger("change")})},_getDataClone:function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&"date"!==c&&"id"!==c&&(b[c]=a[c]);return b},getItems:function(){return this._items},removeItem:function(a){var b=this._items.indexOf(a);-1!==b&&(this._items.splice(b,1),M.removeItem(this._key+a.id),this.trigger("remove_"+a.id,a),this.trigger("removeAny",a),this.trigger("change"))},addItem:function(a){var b=F(),c=this._key+b;a.id=b,a.date=new Date(M.getModifiedTime(c)),this._items.push(a),M.setItem(c,this._getDataClone(a)),this.trigger("add",a),this.trigger("change")},updateItem:function(a){var b=this._items.indexOf(a);if(-1!==b){var c=M.getItem(this._key+a.id);M.setItem(this._key+a.id,this._getDataClone(a)),this.trigger("update_"+a.id,c,a),this.trigger("updateAny",c,a),this.trigger("change")}},clear:function(){for(var a=0;a<this._items.length;)this.removeItem(this._items[0]);this.trigger("clear")},getById:function(a){for(var b=0;b<this._items.length;++b)if(this._items[b].id===a)return this._items[b];return null},onUpdateItem:function(a,b){this.on("updte_"+a.id,b)},onRemoveItem:function(a,b){this.on("remove_"+a.id,b)}};d(G);var H=function(a){return a=M.getFullKey(a),"undefined"!=typeof D[a]?D[a]:(D[a]=E(G),D[a].init.apply(D[a],arguments),D[a])},I=a.init("main._keys",{}),J=a.init("_last_sync",-1),K=!1,L="lightsync_",M={getFullKey:function(a){return-1===a.indexOf(".")?"main."+a:a},onSetItem:function(a,b){M.on("set_"+M.getFullKey(a),b)},onRemoveItem:function(a,b){M.on("remove_"+M.getFullKey(a),b)},onClientSetItem:function(a,b){M.on("clientset_"+M.getFullKey(a),b)},onClientRemoveItem:function(a,b){M.on("clientremove_"+M.getFullKey(a),b)},onServerSetItem:function(a,b){M.on("servertset_"+M.getFullKey(a),b)},onServerRemoveItem:function(a,b){M.on("serverremove_"+M.getFullKey(a),b)},getLastSyncTime:function(){return J},isSyncing:function(){return K},init:function(a){a._name&&(L=a._name+"_",delete a._name),C.init(a)},signout:function(){a.clear(),I=[],J=-1,M.trigger("clear"),C.signout()},sync:function(b){return K?void b("already syncing"):(K=!0,void C.readFile(L+"main",function(c,d){var e=null;if(c){if(404!==c.status)return K=!1,void b(c);e={_keys:{}}}else e=JSON.parse(d);var f=e._keys,g=[],h=[],i=[],j=[];for(var k in I){var l=I[k],m=f[k];l[1]&&m&&m[1]?l[0]>m[0]?g.push(k):l[0]<m[0]&&i.push(k):!l[1]||m&&m[1]?!l[1]&&m&&m[1]&&(l[0]>m[0]?h.push(k):i.push(k)):!m||l[0]>m[0]?g.push(k):j.push(k)}for(var k in f)!I[k]&&f[k][1]&&i.push(k);for(var n=function(a){for(var b={},c=0;c<a.length;++c){var d=a[c],e=d.indexOf("."),f=d.substr(0,e);"undefined"==typeof b[f]&&(b[f]=[]),b[f].push(d.substr(e+1))}return b},o=0;o<g.length;++o)f[g[o]]=I[g[o]];for(var o=0;o<h.length;++o)f[h[o]]=I[h[o]];var p=n(i),q=n(j),r=n(g),s=n(h),t=[];for(var u in p)"main"!==u&&-1===t.indexOf(u)&&t.push(u);for(var u in r)"main"!==u&&-1===t.indexOf(u)&&t.push(u);for(var u in s)"main"!==u&&-1===t.indexOf(u)&&t.push(u);var v={};v.main=e;var w=function(){var c=[];for(var d in r){"main"!==d&&-1===c.indexOf(d)&&c.push(d);for(var e=r[d],i=0;i<e.length;++i)v[d][e[i]]=a.get(d+"."+e[i])}for(var d in s){"main"!==d&&-1===c.indexOf(d)&&c.push(d);for(var e=s[d],i=0;i<e.length;++i)delete v[d][e[i]]}var j=function(){for(var c in p)for(var d=p[c],e=0;e<d.length;++e){var g=c+"."+d[e];a.set(g,v[c][d[e]]),M.trigger("serverset_"+g),M.trigger("serversetAny",g),M.trigger("set_"+g),M.trigger("setAny",g)}for(var c in q)for(var d=q[c],e=0;e<d.length;++e){var g=c+"."+d[e];a.remove(g),M.trigger("serverremove_"+g),M.trigger("serverremoveAny",g),M.trigger("remove_"+g),M.trigger("removeAny",g)}I=f,a.set("main._keys",I),K=!1;var h=(new Date).getTime();a.set("_last_sync",h),J=h,b()},k=function(){C.writeFile(L+"main",JSON.stringify(v.main),function(a){a?(K=!1,b(a)):j()})};g.length||h.length?c.length||k():j();for(var l=0,i=0;i<c.length;++i)C.writeFile(L+c[i],JSON.stringify(v[c[i]]),function(a){a?(K=!1,b(a)):++l===c.length&&k()})};0===t.length&&w();for(var x=0,o=0;o<t.length;++o)!function(a){C.readFile(L+t[a],function(c,d){if(c){if(404!==c.status)return K=!1,void b(c);v[t[a]]={}}else v[t[a]]=JSON.parse(d);++x===t.length&&w()})}(o)}))},getItem:function(b){return a.get(M.getFullKey(b))},setItem:function(b,c){b=M.getFullKey(b),a.set(b,c),I[b]=[(new Date).getTime(),!0],a.set("main._keys",I),M.trigger("clientset_"+b),M.trigger("clientsetAny",b),M.trigger("set_"+b),M.trigger("setAny",b)},hasItem:function(a){return a=M.getFullKey(a),I[a]&&I[a][1]},initItem:function(a,b){return M.hasItem(a)?M.getItem(a):(M.setItem(a,b),b)},removeItem:function(b){M.hasItem(b)&&(b=M.getFullKey(b),a.remove(b),I[b]=[(new Date).getTime(),!1],a.set("main._keys",I),M.trigger("clientremove_"+b),M.trigger("clientremoveAny",b),M.trigger("remove_"+b),M.trigger("removeAny",b))},getModifiedTime:function(a){return a=M.getFullKey(a),I[a]&&I[a][1]?I[a][0]:null},getKeys:function(){var a=[];for(var b in I)I[b][1]&&a.push(b);return a}};return d(M),M.filesRemote=C,M.connect=C.connect,M.getUserInfos=C.getUserInfos,M.isConfigured=C.isConfigured,M.isConnected=C.isConnected,M.getServerName=C.getServerName,M.addServer=C.addServer,M.getCollection=H,M});