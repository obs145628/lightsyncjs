!function(a,b){"function"==typeof define&&define.amd?define(b):"object"==typeof module&&module.exports?module.exports=b():a.lightSync=b()}(this,function(){var a=function(b,c){return"undefined"==typeof c?a.get(b):a.set(b,c)};a.get=function(a){return JSON.parse(localStorage.getItem(a))},a.set=function(a,b){localStorage.setItem(a,JSON.stringify(b))},a.has=function(a){return null!==localStorage.getItem(a)},a.init=function(b,c){return a.has(b)?a.get(b):(a.set(c),c)},a.remove=function(a){localStorage.removeItem(a)},a.clear=function(){localStorage.clear()};var b=function(a,b){a.onreadystatechange=function(){if(4===a.readyState)if(200===a.status){var c=a.responseText,d=null;try{d=JSON.parse(c)}catch(e){d=c}b(null,d)}else b({status:a.status,responseText:a.responseText})}},c={get:function(a,c){var d=new XMLHttpRequest;d.open("GET",a,!0),b(d,c),d.send()},post:function(a,c,d){var e=new XMLHttpRequest;e.open("POST",a,!0),e.setRequestHeader("Content-type","application/json"),b(e,d),e.send(JSON.stringify(c))}},d=function(a){a.on=function(a,b){"undefined"==typeof this._listeners&&(this._listeners={}),"undefined"==typeof this._listeners[a]&&(this._listeners[a]=[]),this._listeners[a].push(b)},a.off=function(a,b){if("undefined"!=typeof this._listeners[a])if("undefined"==typeof b)this._listeners[a]=[];else{var c=this._listeners[a].indexOf(b);-1!==c&&this._listeners[a].splice(c,1)}},a.trigger=function(a){if(this._listeners&&this._listeners[a])for(var b=this._listeners[a],c=Array.prototype.slice.call(arguments,1),d=0;d<b.length;++d)b[d].apply(this,c)}},e=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},f=-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://"),g=null,h=function(a){return a?{status:a.status,responseText:a.responseText}:null},i={init:function(a){g=new Dropbox.Client(a),f?g.authDriver(new Dropbox.AuthDriver.Cordova):g.authDriver(new Dropbox.AuthDriver.Popup({receiverUrl:a.receiverUrl}))},getUserInfos:function(a){g.getAccountInfo(function(b,c){b?a(h(b)):a(null,{name:c.name})})},readFile:function(a,b){g.readFile(a,function(a,c){b(h(a),c)})},writeFile:function(a,b,c){g.writeFile(a,b,function(a){c(h(a))})},connect:function(a){g.authenticate(function(b){b?a(h(b)):i.getUserInfos(a)})}},j=null,k={},l=[],m=function(){for(var a=0;a<l.length;++a)l[a]()},n=function(a){gapi.auth?a():l.push(a)},o=function(a){n(function(b){return b?void a(b):void gapi.auth.authorize({client_id:j,scope:["https://www.googleapis.com/auth/drive"],immediate:!0},function(b){return b.error?void gapi.auth.authorize({client_id:j,scope:["https://www.googleapis.com/auth/drive"],immediate:!1},function(b){a(b.error?b.error:null)}):void a(null)})})},p={init:function(a){j=a.client_id},connect:function(a){o(function(b){return b?void a(b):void gapi.client.load("drive","v2",function(){gapi.client.drive.files.list({}).execute(function(b){if(!b)return void a("unable to get files list");for(var c=b.items,d=0;d<c.length;++d)k[c[d].title]=c[d].id;gapi.client.drive.about.get().execute(function(b){b?a(null,{name:b.name}):a("unable to get user infos")})})})})},readFile:function(a,b){return k[a]?void gapi.client.drive.files.get({fileId:k[a]}).execute(function(a){if(!a)return void b({status:500,responseText:"Internal Server Error"});var c=a.downloadUrl,d=gapi.auth.getToken().access_token,e=new XMLHttpRequest;e.open("GET",c),e.setRequestHeader("Authorization","Bearer "+d),e.onload=function(){b(null,e.responseText)},e.onerror=function(){b({status:e.status,responseText:e.responseText})},e.send()}):void b({status:404,responseText:"File Not Found"})},writeFile:function(a,b,c){var d="-------314159265358979323846",e="\r\n--"+d+"\r\n",f="\r\n--"+d+"--",g="text/plain",h={title:a,mimeType:g},i=e+"Content-Type: application/json\r\n\r\n"+JSON.stringify(h)+e+"Content-Type: "+g+"\r\n\r\n"+b+f,j=k[a],l="/upload/drive/v2/files";j&&(l+="/"+j);var m=gapi.client.request({path:l,method:j?"PUT":"POST",params:{uploadType:"multipart"},headers:{"Content-Type":'multipart/mixed; boundary="'+d+'"'},body:i});m.execute(function(b){b?(j||(k[a]=b.id),c(null)):c("unable to write file")})}},q=null,r={},s=null,t=null,u=function(a){var b="http://localhost/",c="https://accounts.google.com/o/oauth2/auth?"+$.param({client_id:q,redirect_uri:b,response_type:"code",scope:"https://www.googleapis.com/auth/drive"}),d=window.open(c,"_blank","location=no,toolbar=no");$(d).on("loadstart",function(c){var e=c.originalEvent.url,f=/\?code=(.+)$/.exec(e),g=/\?error=(.+)$/.exec(e);(f||g)&&d.close(),f?$.post("https://accounts.google.com/o/oauth2/token",{code:f[1],client_id:q,client_secret:s,redirect_uri:b,grant_type:"authorization_code"}).done(function(b){t=b.access_token,a(null)}).fail(function(b){a(b)}):g&&a(g)})},v=function(a){var b=null;$.ajax({url:"https://www.googleapis.com/drive/v2/files?alt=json&access_token="+t,type:"GET",data:b,dataType:"json",error:function(b,c,d){a(c)},success:function(b){a(null,b)}})},w=function(a){var b=null;$.ajax({url:"https://www.googleapis.com/drive/v2/about?alt=json&access_token="+t,type:"GET",data:b,dataType:"json",error:function(b,c,d){a(c)},success:function(b){a(null,b)}})},x={init:function(a){q=a.client_id,s=a.client_secret},connect:function(a){u(function(b){return b?void a("Unable to connect with google"):void v(function(b,c){if(b)return void a("Unable to get files list");for(var d=c.items,e=0;e<d.length;++e)r[d[e].title]=d[e].id;w(function(b,c){b?a("unable to get user infos"):a(null,{name:c.name})})})})},readFile:function(a,b){if(!r[a])return void b({status:404,responseText:"File Not Found"});var c=null;$.ajax({url:"https://www.googleapis.com/drive/v2/files/"+r[a]+"?alt=json&access_token="+t,type:"GET",data:c,dataType:"json",error:function(a,c,d){b({status:a.status,responseText:a.responseText})},success:function(a){var c=a.downloadUrl,d=new XMLHttpRequest;d.open("GET",c),d.setRequestHeader("Authorization","Bearer "+t),d.onload=function(){b(null,d.responseText)},d.onerror=function(){b({status:d.status,responseText:d.responseText})},d.send()}})},writeFile:function(a,b,c){var d="-------314159265358979323846",e="\r\n--"+d+"\r\n",f="\r\n--"+d+"--",g="text/plain",h={title:a,mimeType:g},i=e+"Content-Type: application/json\r\n\r\n"+JSON.stringify(h)+e+"Content-Type: "+g+"\r\n\r\n"+b+f,j=r[a],k="https://www.googleapis.com/upload/drive/v2/files";j&&(k+="/"+j),$.ajax({url:k+"?"+$.param({alt:"json",access_token:t,uploadType:"multipart"}),method:j?"PUT":"POST",headers:{"Content-Type":'multipart/mixed; boundary="'+d+'"'},data:i,error:function(a,b,d){c(b)},success:function(b){j||(r[a]=b.id),c(null)}})}},y=function(){return a.get("datadb_key")},z=function(b){a.set("datadb_key",b)},A=function(){a.remove("datadb_key")},B="/obsdbserver",C=function(a,b,d){"undefined"==typeof d&&(d={}),d.command=a,d.key=y(),c.post(B,d,function(a,c){a?b(a):c.err?b(c.err):c.content?b(null,c.content):b(null)})},D={init:function(a){a.url&&(B=a.url)},signin:function(a,b,c){C("signin",c,{user:a,pass:b})},signup:function(a,b,c){C("signup",c,{user:a,pass:b})},userAvailable:function(a,b){C("userav",b,{user:a})},testKey:function(a,b){C("testkey",b)},getUserInfos:function(a){C("userinfos",a)},readFile:function(a,b){C("readfile",b,{path:a})},writeFile:function(a,b,c){C("writefile",c,{path:a,content:b})},connect:function(a){var b=y();if(b)D.testKey(b,function(b,c){b?a(b):c?D.getUserInfos(a):(a("invalid key"),A())});else{var c=function(b,c){b?a(b):(z(c),D.getUserInfos(a))},d=prompt("LightServer Username (empty if no account)");if(""===d){d=prompt("New LightServer Username");var e=prompt("LightServer Password"),f=prompt("Repeat Your password");e!==f?a("passwords don't match"):D.signup(d,e,c)}else{var g=prompt("LightServer PassWord");D.signin(d,g,c)}}}},E={},F=a.init("_fr_co_server",null),G=!1,H=a.init("_fr_user_infos",null),I=!1,J=[],K=function(b,c){return I?void J.push(b):F||c?G?void b(null):(I=!0,c||(c=F),void E[c].connect(function(c,d){I=!1,c?b(c):(G=!0,H=d,a.set("_fr_user_infos",d),b(null));for(var e=0;e<J.length;++e)J[e](c)})):void b("no server defined")},L={addServer:function(a,b){E[a]=b},init:function(a){for(var b in a)E[b].init(a[b]);K(function(){})},connect:function(b,c){return F?void c("already conected"):void K(function(d){d?c(d):(F=b,a.set("_fr_co_server",F),c(null))},b)},signout:function(){a.set("_fr_co_server",null),F=null,G=!1,a.set("fr_user_infos",null),H=null,J=[]},isConfigured:function(){return!!F},isConnected:function(){return G},getUserInfos:function(){return H},getServerName:function(){return F},readFile:function(a,b){K(function(c){c?b(c):E[F].readFile(a,b)})},writeFile:function(a,b,c){K(function(d){d?c(d):E[F].writeFile(a,b,c)})}};L.addServer("googledrive",f?x:p),L.addServer("dropbox",i),L.addServer("lightserver",D);var M={},N=function(a){if("undefined"!=typeof Object.create)return Object.create(a);var b=function(){};return b.prototype=a,new b},O=function(){return"xxxxxxxxxxxx4xxxyxxxxxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},P={init:function(a){this._key=a+"_",this._items=[];for(var b=V.getKeys(),c=0;c<b.length;++c)if(0===b[c].indexOf(this._key)){var d=b[c].substr(this._key.length),f=V.getItem(b[c]);f.id=d,f.date=new Date(V.getModifiedTime(b[c])),this._items.push(f)}var g=this;V.on("serversetAny",function(a){if(0===a.indexOf(g._key)){var b=a.substr(g._key.length),c=V.getItem(a);c.date=new Date(V.getModifiedTime(a));for(var d=0;d<g._items.length&&g._items[d].id!==b;++d);if(d===g._items.length)c.id=b,g._items.push(c),g.trigger("add",c);else{var f=e(g._items[d]);for(var h in c)g._items[d][h]=c[h];g.trigger("update_"+c.id,f,c),g.trigger("updateAny",f,c)}g.trigger("change")}}),V.on("serverremoveAny",function(a){if(0===a.indexOf(g._key)){for(var b=a.substr(g._key.length),c=0;g._items[c].id!==b;++c);var d=g._items[c];g._items.splice(c,1),g.trigger("remove_"+d.id,d),g.trigger("removeAny",d),g.trigger("change")}}),V.on("clear",function(){for(var a=0;a<g._items.length;){var b=g._items[0];g._items.splice(0,1),g.trigger("remove_"+b.id,b),g.trigger("removeAny",b)}g.trigger("clear"),g.trigger("change")})},_getDataClone:function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&"date"!==c&&"id"!==c&&(b[c]=a[c]);return b},getItems:function(){return this._items},removeItem:function(a){var b=this._items.indexOf(a);-1!==b&&(this._items.splice(b,1),V.removeItem(this._key+a.id),this.trigger("remove_"+a.id,a),this.trigger("removeAny",a),this.trigger("change"))},addItem:function(a){var b=O(),c=this._key+b;a.id=b,this._items.push(a),V.setItem(c,this._getDataClone(a)),a.date=new Date(V.getModifiedTime(c)),this.trigger("add",a),this.trigger("change")},updateItem:function(a){var b=this._items.indexOf(a);if(-1!==b){var c=V.getItem(this._key+a.id);V.setItem(this._key+a.id,this._getDataClone(a)),a.date=new Date(V.getModifiedTime(this._key+a.id)),this.trigger("update_"+a.id,c,a),this.trigger("updateAny",c,a),this.trigger("change")}},clear:function(){for(var a=0;a<this._items.length;)this.removeItem(this._items[0]);this.trigger("clear")},getById:function(a){for(var b=0;b<this._items.length;++b)if(this._items[b].id===a)return this._items[b];return null},onUpdateItem:function(a,b){this.on("updte_"+a.id,b)},onRemoveItem:function(a,b){this.on("remove_"+a.id,b)}};d(P);var Q=function(a){return a=V.getFullKey(a),"undefined"!=typeof M[a]?M[a]:(M[a]=N(P),M[a].init.apply(M[a],arguments),M[a])};document.addEventListener("deviceready",function(){f&&(window.open=cordova.InAppBrowser.open)},!1);var R=a.init("main._keys",{}),S=a.init("_last_sync",-1),T=!1,U="lightsync_",V={getFullKey:function(a){return-1===a.indexOf(".")?"main."+a:a},onSetItem:function(a,b){V.on("set_"+V.getFullKey(a),b)},onRemoveItem:function(a,b){V.on("remove_"+V.getFullKey(a),b)},onClientSetItem:function(a,b){V.on("clientset_"+V.getFullKey(a),b)},onClientRemoveItem:function(a,b){V.on("clientremove_"+V.getFullKey(a),b)},onServerSetItem:function(a,b){V.on("servertset_"+V.getFullKey(a),b)},onServerRemoveItem:function(a,b){V.on("serverremove_"+V.getFullKey(a),b)},getLastSyncTime:function(){return S},isSyncing:function(){return T},init:function(a){a._name&&(U=a._name+"_",delete a._name),L.init(a)},signout:function(){a.clear(),R=[],S=-1,V.trigger("clear"),L.signout()},sync:function(b){return T?void b("already syncing"):(T=!0,void L.readFile(U+"main",function(c,d){var e=null;if(c){if(404!==c.status)return T=!1,void b(c);e={_keys:{}}}else e=JSON.parse(d);var f=e._keys,g=[],h=[],i=[],j=[];for(var k in R){var l=R[k],m=f[k];l[1]&&m&&m[1]?l[0]>m[0]?g.push(k):l[0]<m[0]&&i.push(k):!l[1]||m&&m[1]?!l[1]&&m&&m[1]&&(l[0]>m[0]?h.push(k):i.push(k)):!m||l[0]>m[0]?g.push(k):j.push(k)}for(var k in f)!R[k]&&f[k][1]&&i.push(k);for(var n=function(a){for(var b={},c=0;c<a.length;++c){var d=a[c],e=d.indexOf("."),f=d.substr(0,e);"undefined"==typeof b[f]&&(b[f]=[]),b[f].push(d.substr(e+1))}return b},o=0;o<g.length;++o)f[g[o]]=R[g[o]];for(var o=0;o<h.length;++o)f[h[o]]=R[h[o]];var p=n(i),q=n(j),r=n(g),s=n(h),t=[];for(var u in p)"main"!==u&&-1===t.indexOf(u)&&t.push(u);for(var u in r)"main"!==u&&-1===t.indexOf(u)&&t.push(u);for(var u in s)"main"!==u&&-1===t.indexOf(u)&&t.push(u);var v={};v.main=e;var w=function(){var c=[];for(var d in r){"main"!==d&&-1===c.indexOf(d)&&c.push(d);for(var e=r[d],i=0;i<e.length;++i)v[d][e[i]]=a.get(d+"."+e[i])}for(var d in s){"main"!==d&&-1===c.indexOf(d)&&c.push(d);for(var e=s[d],i=0;i<e.length;++i)delete v[d][e[i]]}var j=function(){R=f,a.set("main._keys",R);for(var c in p)for(var d=p[c],e=0;e<d.length;++e){var g=c+"."+d[e];a.set(g,v[c][d[e]]),V.trigger("serverset_"+g),V.trigger("serversetAny",g),V.trigger("set_"+g),V.trigger("setAny",g)}for(var c in q)for(var d=q[c],e=0;e<d.length;++e){var g=c+"."+d[e];a.remove(g),V.trigger("serverremove_"+g),V.trigger("serverremoveAny",g),V.trigger("remove_"+g),V.trigger("removeAny",g)}T=!1;var h=(new Date).getTime();a.set("_last_sync",h),S=h,b()},k=function(){L.writeFile(U+"main",JSON.stringify(v.main),function(a){a?(T=!1,b(a)):j()})};g.length||h.length?c.length||k():j();for(var l=0,i=0;i<c.length;++i)L.writeFile(U+c[i],JSON.stringify(v[c[i]]),function(a){a?(T=!1,b(a)):++l===c.length&&k()})};0===t.length&&w();for(var x=0,o=0;o<t.length;++o)!function(a){L.readFile(U+t[a],function(c,d){if(c){if(404!==c.status)return T=!1,void b(c);v[t[a]]={}}else v[t[a]]=JSON.parse(d);++x===t.length&&w()})}(o)}))},getItem:function(b){return a.get(V.getFullKey(b))},setItem:function(b,c){b=V.getFullKey(b),a.set(b,c),R[b]=[(new Date).getTime(),!0],a.set("main._keys",R),V.trigger("clientset_"+b),V.trigger("clientsetAny",b),V.trigger("set_"+b),V.trigger("setAny",b)},hasItem:function(a){return a=V.getFullKey(a),R[a]&&R[a][1]},initItem:function(a,b){return V.hasItem(a)?V.getItem(a):(V.setItem(a,b),b)},removeItem:function(b){V.hasItem(b)&&(b=V.getFullKey(b),a.remove(b),R[b]=[(new Date).getTime(),!1],a.set("main._keys",R),V.trigger("clientremove_"+b),V.trigger("clientremoveAny",b),V.trigger("remove_"+b),V.trigger("removeAny",b))},getModifiedTime:function(a){return a=V.getFullKey(a),R[a]&&R[a][1]?R[a][0]:null},getKeys:function(){var a=[];for(var b in R)R[b][1]&&a.push(b);return a}};return d(V),V.gapiReady=m,V.filesRemote=L,V.connect=L.connect,V.getUserInfos=L.getUserInfos,V.isConfigured=L.isConfigured,V.isConnected=L.isConnected,V.getServerName=L.getServerName,V.addServer=L.addServer,V.getCollection=Q,V});